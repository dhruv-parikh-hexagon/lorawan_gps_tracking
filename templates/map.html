{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta tags for character encoding and responsive viewport -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Page title -->
    <title>Device Location Tracker</title>

    <!-- External CSS and JS libraries -->
    <link href="{% static 'css/bootstrap.min.css'%}" rel="stylesheet">
    <script src="{% static 'js/bootstrap.bundle.min.js'%}"></script>
    <link href="{% static 'css/fonts.css' %}" rel="stylesheet">

    <!-- Leaflet Maps API -->
    <link rel="stylesheet" href="{% static 'css/leaflet.css' %}">
    <script src="{% static 'js/leaflet.js' %}"></script>
    <!-- Select2 library for enhanced dropdowns -->
    <link href="{% static 'css/select2.min.css'%}" rel="stylesheet" />
    <link href="{% static 'css/select2-bootstrap4.css'%}" rel="stylesheet">
    <script src="{% static 'js/leaflet.polylineDecorator.js' %}"></script>

    <style>
        /* General body styling with gradient background */
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
        }

        /* Header styling with flexbox layout */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        /* Message box styling for notifications */
        #message-box, #device-module-message-box {
            margin-top: 1.5rem;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: none;
        }

        /* SOS-specific message box styling */
        #message-box.sos, #device-module-message-box.sos {
            background: #ffe6e6;
            border: 2px solid #ff0000;
            color: #ff0000;
            font-weight: bold;
        }

        /* Close button for SOS messages */
        #message-box.sos .close-btn, #device-module-message-box.sos .close-btn {
            cursor: pointer;
            font-size: 20px;
            margin-left: 10px;
            color: #ff0000;
        }

        /* Error and success message box styles */
        #message-box.error, #device-module-message-box.error {
            background: #fff3f3;
            border: 1px solid #dc3545;
            color: #dc3545;
        }
        #message-box.success, #device-module-message-box.success {
            background: #e6ffe6;
            border: 1px solid #28a745;
            color: #28a745;
        }

        /* Logo styling with hover effect */
        .logo {
            width: 150px;
            height: auto;
            transition: transform 0.3s ease;
        }
        .logo:hover {
            transform: scale(1.05);
        }

        /* Header title styling */
        .header-name {
            font-size: 25px;
            font-weight: 600;
            color: var(--secondary);
            text-align: center;
            flex-grow: 1;
        }

        /* Main content layout using flexbox */
        .content-wrapper {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 20px;
        }

        /* Side menu styling for left and right panels */
        .side-menu {
            width: 360px;
            height: 750px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            background: #ffffff;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* Logout button styling */
        .logout-btn {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            background: #dc3545;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .logout-btn:hover {
            background: #c82333;
        }

        /* Map container styling */
        #map {
            flex-grow: 1;
            height: 750px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            background: #e1e5eb;
            margin: 0 20px;
        }

        .side-menu-right-menu {
            width: 360px;
            height: 750px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            background: #ffffff;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        /* Navigation bar within side menu */
        .side-menu .nav-bar {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background: #007bff;
            color: white;
            font-weight: 600;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .side-menu .nav-bar a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            cursor: pointer;
        }
        .side-menu .nav-bar a.active {
            background: #0056b3;
            border-radius: 5px;
        }

        /* Left menu specific styling */
        .left-menu h3 {
            text-align: center;
            margin-bottom: 20px;
        }
        .left-menu form {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .left-menu .form-label {
            color: #333;
        }
        .left-menu .input-group-text {
            background: #f8f9fa;
            border: 1px solid #ccc;
        }
        .left-menu .btn-primary {
            width: 100%;
            background: #007bff;
            border: none;
            font-weight: bold;
            transition: 0.3s;
        }
        .left-menu .btn-primary:hover {
            background: #0056b3;
        }

        /* Right menu title styling */
        .right-menu-title {
            text-align: center;
            color: #333;
            font-weight: 600;
            margin-bottom: 20px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        /* SOS notifications container */
        #sos-notifications {
            overflow-y: auto;
        }
        .sos-item {
            padding: 10px;
            margin: 5px 0;
            background: #ffe6e6;
            border: 1px solid #ff0000;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .sos-item:hover {
            background: #ffd1d1;
        }
        .sos-item .timestamp {
            font-size: 12px;
            color: #666;
        }

        /* Device configuration container */
        .device-config-container {
            padding: 15px;
        }
        .device-checkbox {
            margin: 10px 0;
            display: flex;
            align-items: center;
        }
        .device-color-box {
            width: 20px;
            height: 20px;
            display: inline-block;
            margin-left: 10px;
            border: 1px solid #ccc;
        }
        .device-checkbox input[type="radio"] {
            margin-right: 10px;
            cursor: pointer;
        }
        .device-checkbox label {
            cursor: pointer;
        }
        .device-checkbox input[type="radio"]:checked + label {
            font-weight: bold;
            color: #007bff;
        }
        .device_msg{
            color:red;
        }
    </style>
</head>
<body>
    <!-- Header section with logos and title -->
    <div class="header">
        <img src="{% static 'logo/logo1.jpg' %}" alt="Left Logo" class="logo">
        <span class="header-name">Vajr Signals Device Location Tracker</span>
        <img src="{% static 'logo/logo2.jpg' %}" alt="Right Logo" class="logo">
    </div>

    <!-- Main content wrapper with three columns -->
    <div class="content-wrapper">
        <!-- Left side menu for device tracking and configuration -->
        <div class="side-menu" id="left-menu">
            <div class="menu-items">
                <!-- Navigation bar to switch between tracker and module -->
                <div class="nav-bar">
                    <a href="#" class="nav-link active" onclick="showDeviceTracker()">Device Tracker</a>
                    <a href="#" class="nav-link" onclick="showDeviceModule()">Device Module</a>
                </div>
                <!-- User welcome message -->
                <div class="user-info">
                    Welcome, <span id="username">{{ user.user_first_name }} {{ user.user_last_name }}</span>
                </div>
                <!-- Device tracker form -->
                <div id="device-tracker-form">
                    <form onsubmit="handleSubmit(event)">
                        <div class="row g-3">
                            <!-- Device ID selection dropdown -->
                            <div class="col-md-12">
                                <label for="device_id" class="form-label fw-bold">Device ID</label>
                                <div class="input-group">
                                    <span class="input-group-text">üì±</span>
                                    <select class="form-select" id="device_id" placeholder="Choose Device" multiple>
                                    </select>
                                </div>
                            </div>
                            <!-- Date picker for tracking -->
                            <div class="col-md-12">
                                <label for="date" class="form-label fw-bold">Date</label>
                                <div class="input-group">
                                    <span class="input-group-text">üìÖ</span>
                                    <input type="date" class="form-control" id="date" required>
                                </div>
                            </div>
                            <!-- Time filter dropdown -->
                            <div class="col-md-12">
                                <label for="time_filter" class="form-label fw-bold">Time Filter</label>
                                <div class="input-group">
                                    <span class="input-group-text">‚è±Ô∏è</span>
                                    <select class="form-select" id="time_filter">
                                        <option value="2s" selected>All Time</option>
                                        <option value="30s">30 Seconds</option>
                                        <option value="1m">1 Minute</option>
                                        <option value="2m">2 Minutes</option>
                                        <option value="5m">5 Minutes</option>
                                        <option value="10m">10 Minutes</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <!-- Submit button for tracking -->
                        <div class="mt-4 text-center">
                            <button type="submit" class="btn btn-primary">Track Location</button>
                        </div>
                    </form>
                    <!-- Message box for tracker feedback -->
                    <div id="message-box"></div>
                </div>
                <!-- Device module section (hidden by default) -->
                <div id="device-module-section" style="display: none;">
                    <h3>Device Configuration</h3>
                     <div id="device_msg" class="mb-3"></div>
                    <div class="device-config-container" style="max-height: 600px; overflow-y: auto;">
                        <!-- Device list for configuration -->
                        <div id="device-list" class="mb-3"></div>
                        <!-- Color picker for device customization -->
                        <div class="mb-3">
                            <label for="color-picker" class="form-label fw-bold">Select Device Color</label>
                            <input type="color" id="color-picker" class="form-control form-control-color" value="#ff0000">
                        </div>
                        <!-- Save configuration button -->
                        <button class="btn btn-primary" onclick="saveDeviceConfig()">Save Configuration</button>
                    </div>
                    <!-- Message box for module feedback -->
                    <div id="device-module-message-box"></div>
                </div>
            </div>
            <!-- Logout button -->
            <button class="logout-btn" onclick="logoutUser()">Logout</button>
        </div>

        <!-- Main map display area -->
        <div id="map"></div>

        <!-- Right side menu for SOS alerts -->
        <div class="side-menu-right-menu" id="right-menu">
            <h3 class="right-menu-title">SOS Alerts</h3>
            <!-- Buttons for sound control -->
            <button class="btn btn-success" style="width: 100%; margin-bottom: 10px;" id="enable-sound" onclick="enableSound()">Enable Sound</button>
            <button class="btn btn-danger" style="width: 100%; margin-bottom: 10px;" id="stopsound" onclick="fetchSOSAlertsstop()">Stop Alerts</button>
            <!-- Container for SOS notifications -->
            <div id="sos-notifications">
                <!-- SOS alerts will be populated here -->
            </div>
            <!-- Mini map modal for SOS location preview -->
            <div id="mini-map-modal" style="display: none; position: fixed; top: 20%; left: 50%; transform: translateX(-50%); width: 400px; height: 400px; background: white; border-radius: 10px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); z-index: 2000; padding: 10px;">
                <div id="mini-map" style="width: 100%; height: 300px;"></div>
                <div id="mini-map-info" style="padding: 10px; text-align: center;"></div>
                <button class="btn btn-danger" style="width: 100%;" onclick="closeMiniMap()">Close</button>
            </div>
        </div>
    </div>

    <!-- Main JavaScript logic for the application -->
    <script>
        // Global variables for map and tracking functionality
        let map; // Main Leaflet Map instance
        let markers = []; // Array to store map markers
        let pathLines = []; // Array to store path lines between markers
        let emergencyAudio; // Audio object for SOS alerts
        let zoomTimeout = null; // Timeout for zoom animation
        let isZooming = false; // Flag to track zooming state
        let isSOSActive = false; // Flag to track SOS state
        let autoRefreshInterval = null; // Interval for auto-refresh
        let infoWindow; // Info window for marker details
        let deviceColors = {}; // Object to store device colors
        let sosAlerts = []; // Array to store SOS alerts
        let previousSOSAlerts = []; // Array to store previous SOS alerts
        let miniMap = null; // Mini map instance for SOS preview
        let miniMarker = null; // Marker for mini map
        let isSoundEnabled = false; // Flag to track if sound is enabled by user
        // Add a new array to store label markers
        let labelMarkers = []; // Array to store device label markers

        // Initialize the main Leaflet Map
        function initMap() {
            console.log("initMap called");
            const mapDiv = document.getElementById('map');
            if (!mapDiv) {
                console.error("Map div not found");
                return;
            }

            try {
                map = L.map('map', {
                    minZoom: 10,
                    maxZoom: 16
                }).setView([34.5200, 74.2667], 16);
                L.tileLayer('/static/MAP/tiles/osm/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                }).addTo(map);
                console.log("Map initialized successfully");
            } catch (error) {
                console.error("Error initializing map:", error);
                showMessage("Error loading map: " + error.message);
                return;
            }

            emergencyAudio = new Audio("{% static 'audio/emergency-alarm-69780.mp3' %}");
            emergencyAudio.loop = true;
            emergencyAudio.preload = 'auto';
            emergencyAudio.onerror = function() {
                console.error("Error loading audio file at {% static 'audio/emergency-alarm-69780.mp3' %}");
                showMessage("Error: Could not load emergency sound file.", true);
            };
            console.log("Audio initialized with source:", emergencyAudio.src);

            loadDeviceConfigs();
        }

        // Enable sound playback
        function enableSound() {
            isSoundEnabled = true;
            document.getElementById('enable-sound').disabled = true;
            console.log("Sound enabled by user.");
        }

        // Play emergency sound for SOS alerts
        function playEmergencySound() {
            if (!isSoundEnabled) {
                console.log("Sound not enabled yet; user must click 'Enable Sound'.");
                showMessage("New SOS alert detected. Click 'Enable Sound' to hear alerts.", false, true);
                return;
            }

            console.log("Attempting to play emergency sound...");
            if (emergencyAudio.paused) { // Only play if not already playing
                emergencyAudio.currentTime = 0; // Reset to start only if paused
                emergencyAudio.play()
                    .then(() => {
                        console.log("‚úÖ Sound is playing successfully!");
                    })
                    .catch(error => {
                        console.error("‚ùå Sound play error:", error);
                        showMessage("Error playing SOS sound: " + error.message, true);
                    });
            } else {
                console.log("Sound is already playing, continuing without restart.");
            }
        }

        // Stop emergency sound
        function stopEmergencySound() {
            if (emergencyAudio && !emergencyAudio.paused) {
                emergencyAudio.pause();
                emergencyAudio.currentTime = 0;
                console.log("‚úÖ Sound stopped");
            } else {
                console.log("No sound to stop.");
            }
        }

        // Display a message in the specified message box
        function showMessage(message, isError = true, isSOS = false, target = 'device-tracker') {
            const messageBox = target === 'device-module'
                ? document.getElementById('device-module-message-box')
                : document.getElementById('message-box');

            messageBox.style.display = 'block';
            messageBox.className = isSOS ? 'sos' : (isError ? 'error' : 'success');

            if (!isError && !isSOS) {
                messageBox.classList.add('success');
            }

            if (isSOS) {
                messageBox.innerHTML = `${message} <span class="close-btn">√ó</span>`;
                const closeBtn = messageBox.querySelector('.close-btn');
                closeBtn.addEventListener('click', () => hideMessage(target));
            } else {
                messageBox.textContent = message;
            }

            if (!isSOS) {
                setTimeout(() => {
                    if (!isSOSActive) {
                        hideMessage(target);
                    }
                }, 5000);
            }
        }

        // Hide the message box
        function hideMessage(target = 'device-tracker') {
            const messageBox = target === 'device-module'
                ? document.getElementById('device-module-message-box')
                : document.getElementById('message-box');

            messageBox.style.display = 'none';
            messageBox.innerHTML = '';
        }

        // Clear all markers and lines from the map - UPDATED FOR LEAFLET
        function clearMap() {
            markers.forEach(marker => marker.remove());
            markers = [];
            pathLines.forEach(line => line.remove());
            pathLines = [];
            labelMarkers.forEach(label => label.remove()); // Remove all label markers
            labelMarkers = []; // Reset label markers array
            map.setView([34.5200, 74.2667], 16);
            // Do not stop sound here to allow it to persist across refreshes
        }

        // Load device IDs into the dropdown
        function loadDeviceIDs() {
            fetch('/get_device_ids/')
                .then(response => response.json())
                .then(deviceIDs => {
                    const select = document.getElementById('device_id');
                    const currentSelected = Array.from(select.selectedOptions).map(option => option.value);
                    const existingOptions = Array.from(select.options).map(option => option.value);

                    const newDevices = deviceIDs.filter(id => !existingOptions.includes(id));
                    if (newDevices.length > 0 || existingOptions.length === 1) {
                        select.innerHTML = '<option value="">All Devices</option>';
                        deviceIDs.forEach(id => {
                            const option = document.createElement('option');
                            option.value = id;
                            option.textContent = id;
                            if (currentSelected.includes(id)) {
                                option.selected = true;
                            }
                            select.appendChild(option);
                        });

                        $(select).select2({
                            theme: 'bootstrap4',
                            width: 'style',
                            placeholder: "Choose Device",
                            allowClear: true,
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading device IDs:', error);
                    showMessage('Error loading device list.');
                });
        }

        // Load device configurations from the server
        function loadDeviceConfigs() {
            fetch('/get_device_configs/')
                .then(response => response.json())
                .then(data => {
                    deviceColors = {};
                    const deviceList = document.getElementById('device-list');
                    deviceList.innerHTML = '';

                    if (data != ''){
                        $('.device-config-container').show();
                        data.forEach(device => {
                            deviceColors[device.device_id] = device.color;
                            const deviceDiv = document.createElement('div');
                            deviceDiv.className = 'device-checkbox';
                            deviceDiv.innerHTML = `
                                <input type="radio"
                                       name="device-selection"
                                       id="device-${device.device_id}"
                                       value="${device.device_id}"
                                       ${device.is_active ? 'checked' : ''}>
                                <label for="device-${device.device_id}" style="margin-left: 5px;">
                                    ${device.device_id}
                                </label>
                                <span class="device-color-box"
                                      style="background-color: ${device.color};"
                                      data-device-id="${device.device_id}"></span>
                            `;
                            deviceList.appendChild(deviceDiv);
                        });
                    } else {
                        $('.device-config-container').hide();
                        const device_msg = document.getElementById('device_msg');
                        device_msg.className = 'device_msg';
                        device_msg.innerHTML = `
                            <p> No Device Found ! </p>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading device configs:', error);
                    showMessage('Error loading device configurations', true, false, 'device-module');
                });
        }

        // Fetch SOS alerts from the server
        function fetchSOSAlerts() {
            console.log("Fetching SOS alerts...");
            fetch('/get_device_emergency_alarms/')
                .then(response => response.json())
                .then(data => {
                    console.log("SOS alerts received:", data);
                    sosAlerts = data;

                    // Filter for new alerts that need sound
                    const newAlerts = sosAlerts.filter(newAlert =>
                        newAlert.is_sound_play == 1
                    );
                    console.log("New SOS alerts detected:", newAlerts);

                    displaySOSAlerts(newAlerts);
                    previousSOSAlerts = [...sosAlerts]; // Update previous alerts
                })
                .catch(error => {
                    console.error('Error fetching SOS alerts:', error);
                    showMessage('Error loading SOS alerts');
                });
        }

        // Fetch SOS alerts from the server stop
        function fetchSOSAlertsstop() {
            console.log('Stopping SOS alerts...');
            fetch('/get_device_emergency_alarms_stop/')
                .then(response => response.json())
                .then(data => {
                    console.log("Stop SOS response:", data);
                    if (data.success === 'True') {
                        stopEmergencySound();
                        fetchSOSAlerts();
                    } else {
                        showMessage(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error fetching SOS alerts stop:', error);
                    showMessage('Error loading SOS alerts stop');
                });
        }

        function displaySOSAlerts(newAlerts = []) {
            const sosContainer = document.getElementById('sos-notifications');
            sosContainer.innerHTML = '';

            if (sosAlerts.length === 0) {
                sosContainer.innerHTML = '<p>No SOS alerts</p>';
                return;
            }

            sosAlerts.forEach((alert, index) => {
                const sosDiv = document.createElement('div');
                sosDiv.className = 'sos-item';

                // Check if the current alert is in the newAlerts list
                const isHighlighted = newAlerts.some(newAlert => newAlert.device_id === alert.device_id && alert.is_sound_play == 1);

                sosDiv.innerHTML = `
                    <strong style="${isHighlighted ? 'color: red; font-size: 18px;' : ''}">
                        #${index + 1} - Device: ${alert.device_id}
                    </strong><br>
                    <span style="${isHighlighted ? 'background: yellow; padding: 2px 5px;' : ''}">
                        Lat: ${alert.latitude}, Lng: ${alert.longitude}
                    </span><br>
                    <span class="timestamp">${alert.timestamp}</span>
                `;

                // Add a highlight class if it matches newAlerts
                if (isHighlighted) {
                    sosDiv.classList.add('highlighted-alert'); // Add a CSS class for better styling
                }

                sosDiv.onclick = () => showMiniMap(
                    { lat: parseFloat(alert.latitude), lng: parseFloat(alert.longitude) },
                    alert.device_id
                );

                sosContainer.appendChild(sosDiv);
            });

            // Play sound only if there are new alerts and sound is enabled
            if (newAlerts.length > 0 && isSoundEnabled) {
                console.log("New SOS alerts detected, playing sound...");
                playEmergencySound();
            } else if (newAlerts.length > 0) {
                console.log("New SOS detected but sound not enabled yet.");
            } else {
                console.log("No new SOS alerts requiring sound.");
            }
        }

        // Show a mini map for SOS location preview
        function showMiniMap(position, deviceId) {
            const miniMapModal = document.getElementById('mini-map-modal');
            const miniMapDiv = document.getElementById('mini-map');
            const miniMapInfo = document.getElementById('mini-map-info');
            miniMapModal.style.display = 'block';

            if (!miniMap) {
                miniMap = L.map('mini-map').setView([position.lat, position.lng], 16);
                L.tileLayer('/static/MAP/tiles/osm/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(miniMap);
            } else {
                miniMap.setView([position.lat, position.lng], 16);
            }

            if (miniMarker) {
                miniMarker.remove();
            }

            // Create a custom red marker icon
            const redIcon = L.icon({
                iconUrl: '{% static "css/images/marker-icon-red.png" %}',
                shadowUrl: '{% static "css/images/marker-shadow.png" %}',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            // Use the custom red icon when creating the marker
            miniMarker = L.marker([position.lat, position.lng], {icon: redIcon}).addTo(miniMap)
                .bindPopup(`<b>Device ID: ${deviceId}</b><br>Lat: ${position.lat.toFixed(6)}, Lng: ${position.lng.toFixed(6)}`)
                .openPopup();

            miniMapInfo.innerHTML = `
                <strong>Device: ${deviceId}</strong><br>
                Lat: ${position.lat.toFixed(6)}, Lng: ${position.lng.toFixed(6)}
            `;
        }

        // Close the mini map modal
        function closeMiniMap() {
            const miniMapModal = document.getElementById('mini-map-modal');
            miniMapModal.style.display = 'none';
            if (miniMarker) {
                miniMarker.remove();
            }
        }

        // Fetch and display device location data on the map with arrows
        function fetchAndDisplayData() {
            hideMessage();
            const selectElement = document.getElementById('device_id');
            const selectedDevices = Array.from(selectElement.selectedOptions).map(option => option.value);
            const date = document.getElementById('date').value;
            const timeFilter = document.getElementById('time_filter').value;

            let apiUrl = selectedDevices.length === 0 || selectedDevices.includes("")
                ? `/get_device_locations/?date=${encodeURIComponent(date)}&time_filter=${encodeURIComponent(timeFilter)}`
                : `/get_device_locations/?${selectedDevices.map(id => `device_id=${encodeURIComponent(id)}`).join('&')}&date=${encodeURIComponent(date)}&time_filter=${encodeURIComponent(timeFilter)}`;

            if (!date) {
                showMessage("Please select a date!");
                clearMap();
                return;
            }

            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    clearMap();
                    if (data.error) {
                        showMessage(data.error);
                        return;
                    }
                    if (!data || data.length === 0) {
                        showMessage(`No data found for this date: ${date} and time filter: ${timeFilter}`);
                        return;
                    }

                    let lastPosition = null;
                    let lastDeviceData = null;
                    let pathCoordinates = {};

                    data.forEach(device => {
                        if (device.latitude && device.longitude) {
                            const position = {
                                lat: parseFloat(device.latitude),
                                lng: parseFloat(device.longitude)
                            };
                            const deviceColor = deviceColors[device.device_id] || '#03bafc';

                            if (!pathCoordinates[device.device_id]) {
                                pathCoordinates[device.device_id] = [];
                            }
                            pathCoordinates[device.device_id].push([position.lat, position.lng]);

                            if (device.is_marker_show == 'True') {
                                // Define marker icon based on device status
                                let markerIcon;
                                if (device.pckt_id === "SOS") {
                                    markerIcon = L.icon({
                                        iconUrl: '{% static "css/images/marker-icon-red.png" %}',
                                        shadowUrl: '{% static "css/images/marker-shadow.png" %}',
                                        iconSize: [25, 41],
                                        iconAnchor: [12, 41],
                                        popupAnchor: [1, -34],
                                        shadowSize: [41, 41]
                                    });
                                } else {
                                    markerIcon = L.divIcon({
                                        html: `<div style="background-color: ${deviceColor}; border: 2px solid #4bf502; border-radius: 50%; width: 16px; height: 16px;"></div>`,
                                        className: 'custom-div-icon',
                                        iconSize: [16, 16],
                                        iconAnchor: [8, 8]
                                    });
                                }

                                // Create marker with label
                                const marker = L.marker([position.lat, position.lng], { icon: markerIcon });

                                // Add label for device ID
                                if (device.device_id) {
                                    const labelIcon = L.divIcon({
                                        html: `<div style="background-color: white; border: 1px solid #ccc; border-radius: 3px; padding: 2px 5px; color: ${device.pckt_id === "SOS" ? "#FF0000" : "#000000"}; font-weight: bold; font-size: 12px;">${device.device_id}</div>`,
                                        className: 'device-label',
                                        iconSize: [50, 20],
                                        iconAnchor: [25, 0]
                                    });
                                    const labelMarker = L.marker([position.lat, position.lng], { icon: labelIcon, interactive: false }).addTo(map);
                                    labelMarkers.push(labelMarker);
                                }

                                // Create popup content
                                const popupContent = `
                                    <div style="font-family: 'Poppins', sans-serif;">
                                        <h6>Device ID: ${device.device_id}</h6>
                                        <p><strong>Latitude:</strong> ${device.latitude}</p>
                                        <p><strong>Longitude:</strong> ${device.longitude}</p>
                                        <p><strong>Status:</strong> ${device.pckt_id === "SOS" ? "Emergency" : "GPS"}</p>
                                        <p><strong>Timestamp:</strong> ${device.actual_date_time}</p>
                                    </div>
                                `;

                                // Add popup to marker
                                marker.bindPopup(popupContent);

                                // Add marker to map
                                marker.addTo(map);

                                // Store marker in markers array
                                markers.push(marker);
                                lastPosition = [position.lat, position.lng];
                                lastDeviceData = { position: [position.lat, position.lng], deviceId: device.device_id, pckt_id: device.pckt_id };
                            }
                        }
                    });

                    // Iterate through each device's pathCoordinates
                    Object.keys(pathCoordinates).forEach(deviceID => {
                        const path = pathCoordinates[deviceID];

                        if (path.length > 1) {
                            // Create a polyline
                            const polyline = L.polyline(path, {
                                color: deviceColors[deviceID] || '#03bafc',
                                weight: 2,
                                opacity: 1
                            }).addTo(map);

                            // Add arrow decorator if the L.polylineDecorator plugin is available
                            if (typeof L.polylineDecorator === 'function') {
                                const arrowDecorator = L.polylineDecorator(polyline, {
                                    patterns: [
                                        {
                                            offset: '100%',  // Position of arrow at the end of each segment
                                            repeat: '100px', // Repeat interval like Google Maps
                                            symbol: L.Symbol.arrowHead({
                                                pixelSize: 8,
                                                polygon: true,
                                                pathOptions: {
                                                    stroke: true,
                                                    color: '#000000',
                                                    weight: 2,
                                                    fillColor: '#000000',
                                                    fillOpacity: 1
                                                }
                                            })
                                        }
                                    ]
                                }).addTo(map);
                                pathLines.push(arrowDecorator);
                            }

                            // Store references
                            pathLines.push(polyline);
                        }
                    });

                    if (lastPosition) {
                        // Zoom in to the last device's position
                        map.setView(lastPosition, 16);

                        // Zoom out to default view after a delay (e.g., 3 seconds)
                        setTimeout(() => {
                            map.setView(lastPosition, 16, { animate: true });
                        }, 2000); // Adjust the delay (in milliseconds) as needed
                    }

                    fetchSOSAlerts(); // Fetch SOS alerts after updating map
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    showMessage("Error fetching location data.");
                    clearMap();
                });
        }

        // Zoom to SOS location with animation
        function zoomToSOS(position, duration) {
            isZooming = true;
            map.setView([position.lat, position.lng], 16, { animate: true });

            if (zoomTimeout) clearTimeout(zoomTimeout);

            zoomTimeout = setTimeout(() => {
                isZooming = false;
                isSOSActive = false;
                fetchAndDisplayData();
            }, duration);
        }

        // Function to check if the selected date is today
        function isToday(selectedDate) {
            const today = new Date();
            const selected = new Date(selectedDate);
            return (
                selected.getDate() === today.getDate() &&
                selected.getMonth() === today.getMonth() &&
                selected.getFullYear() === today.getFullYear()
            );
        }

        // Start auto-refreshing the map data
        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            const date = document.getElementById('date').value;

            if (isToday(date)) {
                autoRefreshInterval = setInterval(() => {
                    if (!isSOSActive && !isZooming) {
                        fetchAndDisplayData();
                        loadDeviceIDs();
                    }
                }, 2000);
                console.log("Auto-refresh started for today");
            } else {
                console.log("Auto-refresh not started; date is not today");
            }
        }

        // Stop auto-refreshing
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log("Auto-refresh stopped");
            }
        }

        // Handle form submission for tracking
        function handleSubmit(event) {
            event.preventDefault();
            stopAutoRefresh();
            fetchAndDisplayData();
            startAutoRefresh();
        }

        // Show the Device Tracker section
        function showDeviceTracker() {
            document.getElementById('device-tracker-form').style.display = 'block';
            document.getElementById('device-module-section').style.display = 'none';
            document.querySelector('.nav-bar a:nth-child(1)').classList.add('active');
            document.querySelector('.nav-bar a:nth-child(2)').classList.remove('active');
            hideMessage('device-module');
            startAutoRefresh();
        }

        // Show the Device Module section
        function showDeviceModule() {
            document.getElementById('device-tracker-form').style.display = 'none';
            document.getElementById('device-module-section').style.display = 'block';
            document.querySelector('.nav-bar a:nth-child(1)').classList.remove('active');
            document.querySelector('.nav-bar a:nth-child(2)').classList.add('active');
            hideMessage('device-tracker');
            startAutoRefresh();
            loadDeviceConfigs();
        }

        // Save device configuration changes
        function saveDeviceConfig() {
            const devices = Array.from(document.querySelectorAll('.device-checkbox input[type="radio"]'));
            const colorPicker = document.getElementById('color-picker');
            const selectedDevice = devices.find(device => device.checked);

            if (!selectedDevice) {
                showMessage('Please select a device to configure', true, false, 'device-module');
                return;
            }

            const configData = devices.map(device => ({
                device_id: device.value,
                is_active: device.checked,
                color: device.checked ? colorPicker.value : deviceColors[device.value]
            }));

            showMessage('Saving configuration...', false, false, 'device-module');

            fetch('/save_device_configs/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(configData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Color changes successfully!', false, false, 'device-module');
                    setTimeout(() => hideMessage('device-module'), 3000);
                    loadDeviceConfigs();
                    fetchAndDisplayData();
                } else {
                    showMessage(data.error || 'Error saving configuration', true, false, 'device-module');
                }
            })
            .catch(error => {
                console.error('Error saving config:', error);
                showMessage('Network error while saving configuration', true, false, 'device-module');
            });
        }

        // Utility function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Window onload event to initialize the application
        window.onload = function() {
            function setDefaultDate() {
                const dateInput = document.getElementById('date');
                const today = new Date();
                dateInput.value = today.toISOString().split('T')[0];
            }
            initMap();
            setDefaultDate();
            loadDeviceIDs();
            fetchAndDisplayData();
            startAutoRefresh();

            document.getElementById('device_id').addEventListener('change', stopAutoRefresh);
            document.getElementById('date').addEventListener('input', () => {
                stopAutoRefresh();
                fetchAndDisplayData();
                startAutoRefresh();
            });
            document.getElementById('time_filter').addEventListener('change', () => {
                stopAutoRefresh();
                fetchAndDisplayData();
                startAutoRefresh();
            });
        };
    </script>

    <!-- Additional JavaScript libraries -->
    <script src="{% static 'js/jquery-3.3.1.slim.min.js' %}"></script>
    <script src="{% static 'js/popper.min.js' %}"></script>
    <script src="{% static 'js/bootstrap.min.js' %}"></script>
    <script src="{% static 'js/select2.min.js' %}"></script>

    <!-- Initialize Select2 for all select elements -->
    <script>
        $(function () {
            $('select').each(function () {
                $(this).select2({
                    theme: 'bootstrap4',
                    width: 'style',
                    placeholder: $(this).attr('placeholder'),
                    allowClear: Boolean($(this).data('allow-clear')),
                });
            });
        });
    </script>

    <!-- Logout function to redirect to logout URL -->
    <script>
        function logoutUser() {
            window.location.href = "{% url 'logout' %}";
        }
    </script>
</body>
</html>