{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta tags for character encoding and responsive viewport -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Page title -->
    <title>Device Location Tracker</title>

    <!-- External CSS and JS libraries -->
    <link href="{% static 'css/bootstrap.min.css'%}" rel="stylesheet">
    <script src="{% static 'js/bootstrap.bundle.min.js'%}"></script>
    <link href="{% static 'css/fonts.css'  %}" rel="stylesheet">

    <!-- Google Maps API script with API key and callback to initialize map -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC-85qgQTV1ZmfZpb8l-s9P5zRPEjkvkCM&callback=initMap" defer></script>

    <!-- Select2 library for enhanced dropdowns -->
    <link href="{% static 'css/select2.min.css'%}" rel="stylesheet" />
    <link href="{% static 'css/select2-bootstrap4.css'%}" rel="stylesheet">

    <style>
        /* General body styling with gradient background */
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
        }

        /* Header styling with flexbox layout */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        /* Message box styling for notifications */
        #message-box, #device-module-message-box {
            margin-top: 1.5rem;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: none;
        }

        /* SOS-specific message box styling */
        #message-box.sos, #device-module-message-box.sos {
            background: #ffe6e6;
            border: 2px solid #ff0000;
            color: #ff0000;
            font-weight: bold;
        }

        /* Close button for SOS messages */
        #message-box.sos .close-btn, #device-module-message-box.sos .close-btn {
            cursor: pointer;
            font-size: 20px;
            margin-left: 10px;
            color: #ff0000;
        }

        /* Error and success message box styles */
        #message-box.error, #device-module-message-box.error {
            background: #fff3f3;
            border: 1px solid #dc3545;
            color: #dc3545;
        }
        #message-box.success, #device-module-message-box.success {
            background: #e6ffe6;
            border: 1px solid #28a745;
            color: #28a745;
        }

        /* Logo styling with hover effect */
        .logo {
            width: 150px;
            height: auto;
            transition: transform 0.3s ease;
        }
        .logo:hover {
            transform: scale(1.05);
        }

        /* Header title styling */
        .header-name {
            font-size: 25px;
            font-weight: 600;
            color: var(--secondary);
            text-align: center;
            flex-grow: 1;
        }

        /* Main content layout using flexbox */
        .content-wrapper {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 20px;
        }

        /* Side menu styling for left and right panels */
        .side-menu {
            width: 360px;
            height: 750px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            background: #ffffff;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* Logout button styling */
        .logout-btn {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            background: #dc3545;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .logout-btn:hover {
            background: #c82333;
        }

        /* Map container styling */
        #map {
            flex-grow: 1;
            height: 750px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            background: #e1e5eb;
            margin: 0 20px;
        }

        .side-menu-right-menu {
            width: 360px;
            height: 750px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            background: #ffffff;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        /* Navigation bar within side menu */
        .side-menu .nav-bar {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background: #007bff;
            color: white;
            font-weight: 600;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .side-menu .nav-bar a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            cursor: pointer;
        }
        .side-menu .nav-bar a.active {
            background: #0056b3;
            border-radius: 5px;
        }

        /* Left menu specific styling */
        .left-menu h3 {
            text-align: center;
            margin-bottom: 20px;
        }
        .left-menu form {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .left-menu .form-label {
            color: #333;
        }
        .left-menu .input-group-text {
            background: #f8f9fa;
            border: 1px solid #ccc;
        }
        .left-menu .btn-primary {
            width: 100%;
            background: #007bff;
            border: none;
            font-weight: bold;
            transition: 0.3s;
        }
        .left-menu .btn-primary:hover {
            background: #0056b3;
        }

        /* Right menu title styling */
        .right-menu-title {
            text-align: center;
            color: #333;
            font-weight: 600;
            margin-bottom: 20px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        /* SOS notifications container */
        #sos-notifications {
            max-height: 500px;
            overflow-y: auto;
        }
        .sos-item {
            padding: 10px;
            margin: 5px 0;
            background: #ffe6e6;
            border: 1px solid #ff0000;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .sos-item:hover {
            background: #ffd1d1;
        }
        .sos-item .timestamp {
            font-size: 12px;
            color: #666;
        }

        /* Device configuration container */
        .device-config-container {
            padding: 15px;
        }
        .device-checkbox {
            margin: 10px 0;
            display: flex;
            align-items: center;
        }
        .device-color-box {
            width: 20px;
            height: 20px;
            display: inline-block;
            margin-left: 10px;
            border: 1px solid #ccc;
        }
        .device-checkbox input[type="radio"] {
            margin-right: 10px;
            cursor: pointer;
        }
        .device-checkbox label {
            cursor: pointer;
        }
        .device-checkbox input[type="radio"]:checked + label {
            font-weight: bold;
            color: #007bff;
        }
    </style>
</head>
<body>
    <!-- Header section with logos and title -->
    <div class="header">
        <img src="{% static 'logo/logo1.jpg' %}" alt="Left Logo" class="logo">
        <span class="header-name">Vajr Signals Device Location Tracker</span>
        <img src="{% static 'logo/logo2.jpg' %}" alt="Right Logo" class="logo">
    </div>

    <!-- Main content wrapper with three columns -->
    <div class="content-wrapper">
        <!-- Left side menu for device tracking and configuration -->
        <div class="side-menu" id="left-menu">
            <div class="menu-items">
                <!-- Navigation bar to switch between tracker and module -->
                <div class="nav-bar">
                    <a href="#" class="nav-link active" onclick="showDeviceTracker()">Device Tracker</a>
                    <a href="#" class="nav-link" onclick="showDeviceModule()">Device Module</a>
                </div>
                <!-- User welcome message -->
                <div class="user-info">
                    Welcome, <span id="username">{{ user.user_first_name }} {{ user.user_last_name }}</span>
                </div>
                <!-- Device tracker form -->
                <div id="device-tracker-form">
                    <form onsubmit="handleSubmit(event)">
                        <div class="row g-3">
                            <!-- Device ID selection dropdown -->
                            <div class="col-md-12">
                                <label for="device_id" class="form-label fw-bold">Device ID</label>
                                <div class="input-group">
                                    <span class="input-group-text">üì±</span>
                                    <select class="form-select" id="device_id" placeholder="Choose Device" multiple>
                                    </select>
                                </div>
                            </div>
                            <!-- Date picker for tracking -->
                            <div class="col-md-12">
                                <label for="date" class="form-label fw-bold">Date</label>
                                <div class="input-group">
                                    <span class="input-group-text">üìÖ</span>
                                    <input type="date" class="form-control" id="date" required>
                                </div>
                            </div>
                            <!-- Time filter dropdown -->
                            <div class="col-md-12">
                                <label for="time_filter" class="form-label fw-bold">Time Filter</label>
                                <div class="input-group">
                                    <span class="input-group-text">‚è±Ô∏è</span>
                                    <select class="form-select" id="time_filter">
                                        <option value="2s" selected>All Time</option>
                                        <option value="30s">30 Seconds</option>
                                        <option value="1m">1 Minute</option>
                                        <option value="2m">2 Minutes</option>
                                        <option value="5m">5 Minutes</option>
                                        <option value="10m">10 Minutes</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <!-- Submit button for tracking -->
                        <div class="mt-4 text-center">
                            <button type="submit" class="btn btn-primary">Track Location</button>
                        </div>
                    </form>
                    <!-- Message box for tracker feedback -->
                    <div id="message-box"></div>
                </div>
                <!-- Device module section (hidden by default) -->
                <div id="device-module-section" style="display: none;">
                    <h3>Device Configuration</h3>
                    <div class="device-config-container" style="max-height: 600px; overflow-y: auto;">
                        <!-- Device list for configuration -->
                        <div id="device-list" class="mb-3"></div>
                        <!-- Color picker for device customization -->
                        <div class="mb-3">
                            <label for="color-picker" class="form-label fw-bold">Select Device Color</label>
                            <input type="color" id="color-picker" class="form-control form-control-color" value="#ff0000">
                        </div>
                        <!-- Save configuration button -->
                        <button class="btn btn-primary" onclick="saveDeviceConfig()">Save Configuration</button>
                    </div>
                    <!-- Message box for module feedback -->
                    <div id="device-module-message-box"></div>
                </div>
            </div>
            <!-- Logout button -->
            <button class="logout-btn" onclick="logoutUser()">Logout</button>
        </div>

        <!-- Main map display area -->
        <div id="map"></div>

        <!-- Right side menu for SOS alerts -->
        <div class="side-menu-right-menu" id="right-menu">
            <h3 class="right-menu-title">SOS Alerts</h3>
            <!-- Container for SOS notifications -->
            <div id="sos-notifications">
                <!-- SOS alerts will be populated here -->
            </div>
            <!-- Mini map modal for SOS location preview -->
            <div id="mini-map-modal" style="display: none; position: fixed; top: 20%; left: 50%; transform: translateX(-50%); width: 400px; height: 400px; background: white; border-radius: 10px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); z-index: 2000; padding: 10px;">
                <div id="mini-map" style="width: 100%; height: 300px;"></div>
                <div id="mini-map-info" style="padding: 10px; text-align: center;"></div>
                <button class="btn btn-danger" style="width: 100%;" onclick="closeMiniMap()">Close</button>
            </div>
        </div>
    </div>

    <!-- Main JavaScript logic for the application -->
    <script>
        // Global variables for map and tracking functionality
        let map; // Main Google Map instance
        let markers = []; // Array to store map markers
        let pathLines = []; // Array to store path lines between markers
        let emergencyAudio; // Audio object for SOS alerts
        let zoomTimeout = null; // Timeout for zoom animation
        let isZooming = false; // Flag to track zooming state
        let isSOSActive = false; // Flag to track SOS state
        let autoRefreshInterval = null; // Interval for auto-refresh
        let infoWindow; // Google Maps InfoWindow for marker details
        let deviceColors = {}; // Object to store device colors
        let sosAlerts = []; // Array to store SOS alerts
        let miniMap = null; // Mini map instance for SOS preview
        let miniMarker = null; // Marker for mini map

        // Initialize the main Google Map
        function initMap() {
            console.log("initMap called");
            const mapDiv = document.getElementById('map');
            if (!mapDiv) {
                console.error("Map div not found");
                return;
            }

            try {
                // Create a new Google Map instance with default settings
                map = new google.maps.Map(mapDiv, {
                    zoom: 10,
                    center: { lat: 23.04324, lng: 72.57662 }, // Default center (Ahmedabad, India)
                    scrollwheel: true,
                    gestureHandling: 'greedy'
                });
                console.log("Map initialized successfully");
            } catch (error) {
                console.error("Error initializing map:", error);
                showMessage("Error loading map: " + error.message);
                return;
            }

            // Initialize InfoWindow and emergency audio
            infoWindow = new google.maps.InfoWindow();
            emergencyAudio = new Audio('/emergency-alarm-69780.mp3');
            emergencyAudio.loop = true;
            emergencyAudio.preload = 'auto';
            emergencyAudio.onerror = function() {
                console.error('Error loading audio file');
                showMessage("Emergency SOS Detected! (Check audio file path)", false, true);
            };

            // Load initial device configurations
            loadDeviceConfigs();
        }

        // Play emergency sound for SOS alerts
        function playEmergencySound() {
            try {
                emergencyAudio.currentTime = 0;
                emergencyAudio.play().catch(error => {
                    console.error('Sound play error:', error);
                    showMessage("Emergency SOS Detected! (Sound unavailable)", false, true);
                });
            } catch (error) {
                console.error('Sound play error:', error);
            }
        }

        // Stop the emergency sound
        function stopEmergencySound() {
            if (emergencyAudio) {
                emergencyAudio.pause();
                emergencyAudio.currentTime = 0;
            }
        }

        // Display a message in the specified message box
        function showMessage(message, isError = true, isSOS = false, target = 'device-tracker') {
            const messageBox = target === 'device-module'
                ? document.getElementById('device-module-message-box')
                : document.getElementById('message-box');

            messageBox.style.display = 'block';
            messageBox.className = isSOS ? 'sos' : (isError ? 'error' : 'success');

            if (!isError && !isSOS) {
                messageBox.classList.add('success');
            }

            if (isSOS) {
                messageBox.innerHTML = `${message} <span class="close-btn">√ó</span>`;
                const closeBtn = messageBox.querySelector('.close-btn');
                closeBtn.addEventListener('click', () => hideMessage(target));
            } else {
                messageBox.textContent = message;
            }

            if (!isSOS) {
                setTimeout(() => {
                    if (!isSOSActive) {
                        hideMessage(target);
                    }
                }, 5000); // Auto-hide after 5 seconds unless SOS
            }

            if (isSOS) playEmergencySound();
        }

        // Hide the message box
        function hideMessage(target = 'device-tracker') {
            const messageBox = target === 'device-module'
                ? document.getElementById('device-module-message-box')
                : document.getElementById('message-box');

            messageBox.style.display = 'none';
            messageBox.innerHTML = '';
            stopEmergencySound();
        }

        // Clear all markers and lines from the map
        function clearMap() {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            pathLines.forEach(line => line.setMap(null));
            pathLines = [];
            map.setCenter({ lat: 23.04324, lng: 72.57662 });
            map.setZoom(20);
            stopEmergencySound();
        }

        // Load device IDs into the dropdown
        function loadDeviceIDs() {
            fetch('/get_device_ids/')
                .then(response => response.json())
                .then(deviceIDs => {
                    const select = document.getElementById('device_id');
                    const currentSelected = Array.from(select.selectedOptions).map(option => option.value);
                    const existingOptions = Array.from(select.options).map(option => option.value);

                    const newDevices = deviceIDs.filter(id => !existingOptions.includes(id));
                    if (newDevices.length > 0 || existingOptions.length === 1) {
                        select.innerHTML = '<option value="">All Devices</option>';
                        deviceIDs.forEach(id => {
                            const option = document.createElement('option');
                            option.value = id;
                            option.textContent = id;
                            if (currentSelected.includes(id)) {
                                option.selected = true;
                            }
                            select.appendChild(option);
                        });

                        // Initialize Select2 for enhanced dropdown
                        $(select).select2({
                            theme: 'bootstrap4',
                            width: 'style',
                            placeholder: "Choose Device",
                            allowClear: true,
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading device IDs:', error);
                    showMessage('Error loading device list.');
                });
        }

        // Load device configurations from the server
        function loadDeviceConfigs() {
            fetch('/get_device_configs/')
                .then(response => response.json())
                .then(data => {
                    deviceColors = {};
                    const deviceList = document.getElementById('device-list');
                    deviceList.innerHTML = '';

                    data.forEach(device => {
                        deviceColors[device.device_id] = device.color;
                        const deviceDiv = document.createElement('div');
                        deviceDiv.className = 'device-checkbox';
                        deviceDiv.innerHTML = `
                            <input type="radio"
                                   name="device-selection"
                                   id="device-${device.device_id}"
                                   value="${device.device_id}"
                                   ${device.is_active ? 'checked' : ''}>
                            <label for="device-${device.device_id}" style="margin-left: 5px;">
                                ${device.device_id}
                            </label>
                            <span class="device-color-box"
                                  style="background-color: ${device.color};"
                                  data-device-id="${device.device_id}"></span>
                        `;
                        deviceList.appendChild(deviceDiv);
                    });
                })
                .catch(error => {
                    console.error('Error loading device configs:', error);
                    showMessage('Error loading device configurations', true, false, 'device-module');
                });
        }

        // Fetch SOS alerts from the server
        function fetchSOSAlerts() {
            fetch('/get_device_emergency_alarms/')
                .then(response => response.json())
                .then(data => {
                    sosAlerts = data;
                    displaySOSAlerts();
                })
                .catch(error => {
                    console.error('Error fetching SOS alerts:', error);
                    showMessage('Error loading SOS alerts');
                });
        }

        // Display SOS alerts in the right menu
        function displaySOSAlerts() {
            const sosContainer = document.getElementById('sos-notifications');
            sosContainer.innerHTML = '';

            if (sosAlerts.length === 0) {
                sosContainer.innerHTML = '<p>No SOS alerts</p>';
                return;
            }

            sosAlerts.forEach((alert, index) => {
                const sosDiv = document.createElement('div');
                sosDiv.className = 'sos-item';
                sosDiv.innerHTML = `
                    <strong>#${index + 1} - Device: ${alert.device_id}</strong><br>
                    Lat: ${alert.latitude}, Lng: ${alert.longitude}<br>
                    <span class="timestamp">${alert.timestamp}</span>
                `;
                sosDiv.onclick = () => showMiniMap(
                    { lat: parseFloat(alert.latitude), lng: parseFloat(alert.longitude) },
                    alert.device_id
                );
                sosContainer.appendChild(sosDiv);
            });
        }

        // Show a mini map for SOS location preview
        function showMiniMap(position, deviceId) {
            const miniMapModal = document.getElementById('mini-map-modal');
            const miniMapDiv = document.getElementById('mini-map');
            const miniMapInfo = document.getElementById('mini-map-info');

            miniMapModal.style.display = 'block';

            if (!miniMap) {
                miniMap = new google.maps.Map(miniMapDiv, {
                    zoom: 15,
                    center: position,
                    scrollwheel: true,
                    gestureHandling: 'greedy',
                    disableDefaultUI: true
                });
            } else {
                miniMap.setCenter(position);
                miniMap.setZoom(15);
            }

            if (miniMarker) {
                miniMarker.setMap(null);
            }

            miniMarker = new google.maps.Marker({
                position: position,
                map: miniMap,
                title: `Device ID: ${deviceId}`,
                label: {
                    text: deviceId,
                    color: "#FF0000",
                    fontSize: "12px",
                    fontWeight: "bold"
                },
                icon: {
                    url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
                    scaledSize: new google.maps.Size(45, 45)
                }
            });

            miniMapInfo.innerHTML = `
                <strong>Device: ${deviceId}</strong><br>
                Lat: ${position.lat.toFixed(6)}, Lng: ${position.lng.toFixed(6)}
            `;
        }

        // Close the mini map modal
        function closeMiniMap() {
            const miniMapModal = document.getElementById('mini-map-modal');
            miniMapModal.style.display = 'none';
            if (miniMarker) {
                miniMarker.setMap(null);
            }
        }

        // Fetch and display device location data on the map with arrows
        function fetchAndDisplayData() {
            hideMessage();
            const selectElement = document.getElementById('device_id');
            const selectedDevices = Array.from(selectElement.selectedOptions).map(option => option.value);
            const date = document.getElementById('date').value;
            const timeFilter = document.getElementById('time_filter').value;

            let apiUrl = selectedDevices.length === 0 || selectedDevices.includes("")
                ? `/get_device_locations/?date=${encodeURIComponent(date)}&time_filter=${encodeURIComponent(timeFilter)}`
                : `/get_device_locations/?${selectedDevices.map(id => `device_id=${encodeURIComponent(id)}`).join('&')}&date=${encodeURIComponent(date)}&time_filter=${encodeURIComponent(timeFilter)}`;

            if (!date) {
                showMessage("Please select a date!");
                clearMap();
                return;
            }

            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    clearMap();
                    if (data.error) {
                        showMessage(data.error);
                        return;
                    }
                    if (!data || data.length === 0) {
                        showMessage(`No data found for this date: ${date} and time filter: ${timeFilter}`);
                        return;
                    }

                    let lastPosition = null;
                    let lastDeviceData = null;
                    let pathCoordinates = {};
                    let marker="";
                    data.forEach(device => {
                        if (device.latitude && device.longitude) {
                            const position = {
                                lat: parseFloat(device.latitude),
                                lng: parseFloat(device.longitude)
                            };
                            const deviceColor = deviceColors[device.device_id] || '#03bafc';

                            if (!pathCoordinates[device.device_id]) {
                                pathCoordinates[device.device_id] = [];
                            }
                            pathCoordinates[device.device_id].push(position);
                            if (device.is_marker_show=='True'){
                                console.log('yes...',device.is_marker_show)
                                 marker = new google.maps.Marker({
                                    position: position,
                                    map: map,
                                    title: `Device ID: ${device.device_id}`,
                                    label: {
                                        text: device.device_id,
                                        color: device.pckt_id === "SOS" ? "#FF0000" : "#000000",
                                        fontSize: "12px",
                                        fontWeight: "bold"
                                    },
                                    icon: device.pckt_id === "SOS" ? {
                                        url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
                                        scaledSize: new google.maps.Size(45, 45)
                                    } : {
                                        path: google.maps.SymbolPath.CIRCLE,
                                        fillColor: deviceColor,
                                        fillOpacity: 1,
                                        scale: 8,
                                        strokeColor: "#4bf502",
                                        strokeWeight: 2
                                    }
                                });
                                const infoContent = `
                                <div style="font-family: 'Poppins', sans-serif;">
                                    <h6>Device ID: ${device.device_id}</h6>
                                    <p><strong>Latitude:</strong> ${device.latitude}</p>
                                    <p><strong>Longitude:</strong> ${device.longitude}</p>
                                    <p><strong>Status:</strong> ${device.pckt_id === "SOS" ? "Emergency" : "GPS"}</p>
                                    <p><strong>Timestamp:</strong> ${device.actual_date_time}</p>
                                </div>
                            `;

                            marker.addListener('click', () => {
                                infoWindow.setContent(infoContent);
                                infoWindow.open(map, marker);
                            });

                            markers.push(marker);
                            lastPosition = position;
                            lastDeviceData = { position, deviceId: device.device_id, pckt_id: device.pckt_id };


                        }

                        else{
                            console.log('NO...',device.is_marker_show)
                                 marker = new google.maps.Marker({
                                    position: position,
                                    map: map,
                                    title: `Device ID: ${device.device_id}`,
                                    label: {
                                        //text: device.device_id,
                                        color: device.pckt_id === "SOS" ? "#FF0000" : "#0ca6f2",
                                        fontSize: "12px",
                                        fontWeight: "bold"
                                    },
                                    icon: device.pckt_id === "SOS" ? {
                                        url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
                                        scaledSize: new google.maps.Size(45, 45)
                                    } : {
                                        path: google.maps.SymbolPath.CIRCLE,
                                        fillColor: '#f20cf2',
                                        fillOpacity: 1,
                                        scale: 0,
                                        strokeColor: "#ffffff",
                                        strokeWeight: 2
                                    }
                                });
                                const infoContent = `
                                <div style="font-family: 'Poppins', sans-serif;">
                                    <h6>Device ID: ${device.device_id}</h6>
                                    <p><strong>Latitude:</strong> ${device.latitude}</p>
                                    <p><strong>Longitude:</strong> ${device.longitude}</p>
                                    <p><strong>Status:</strong> ${device.pckt_id === "SOS" ? "Emergency" : "GPS"}</p>
                                    <p><strong>Timestamp:</strong> ${device.actual_date_time}</p>
                                </div>
                            `;

                            marker.addListener('click', () => {
                                infoWindow.setContent(infoContent);
                                infoWindow.open(map, marker);
                            });

                            markers.push(marker);
                            lastPosition = position;
                            lastDeviceData = { position, deviceId: device.device_id, pckt_id: device.pckt_id };
                            }

                        }
                    });

                    // Define an arrow symbol for the polyline
                    const arrowSymbol = {
                        path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                        scale: 3,
                        strokeColor: '#000000',
                        fillColor: '#000000',
                        fillOpacity: 1
                    };

                    // Draw path lines with arrows for each device
                    Object.keys(pathCoordinates).forEach(deviceID => {
                        const path = pathCoordinates[deviceID];
                        if (path.length > 1) {
                            const segment = new google.maps.Polyline({
                                path: path,
                                geodesic: true,
                                strokeColor: deviceColors[deviceID] || '#03bafc',
                                strokeOpacity: 1.0,
                                strokeWeight: 2,
                                icons: [{
                                    icon: arrowSymbol,
                                    offset: '100%',
                                    repeat: '100px'
                                }]
                            });
                            segment.setMap(map);
                            pathLines.push(segment);
                        }
                    });

                    // Handle SOS or normal positioning
                    if (lastDeviceData && lastDeviceData.pckt_id === "SOS") {
                        showMessage(`Emergency SOS Detected! Device: ${lastDeviceData.deviceId}`, false, true);
                        zoomToSOS(lastDeviceData.position, 5000);
                    } else if (lastPosition) {
                        stopEmergencySound();
                        map.setCenter(lastPosition);
                        map.setZoom(20);
                    } else {
                        showMessage("No valid location data available.");
                    }

                    fetchSOSAlerts();
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    showMessage("Error fetching location data.");
                    clearMap();
                });
        }

        // Zoom to SOS location with animation
        function zoomToSOS(position, duration) {
            isZooming = true;
            map.setCenter(position);
            map.setZoom(21);
            if (zoomTimeout) clearTimeout(zoomTimeout);
            zoomTimeout = setTimeout(() => {
                isZooming = false;
                isSOSActive = false;
                fetchAndDisplayData();
            }, duration);
        }

        // Function to check if the selected date is today
        function isToday(selectedDate) {
            const today = new Date();
            const selected = new Date(selectedDate);
            return (
                selected.getDate() === today.getDate() &&
                selected.getMonth() === today.getMonth() &&
                selected.getFullYear() === today.getFullYear()
            );
        }

        // Start auto-refreshing the map data only if the date is today
        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            const date = document.getElementById('date').value;

            if (isToday(date)) {
                autoRefreshInterval = setInterval(() => {
                    if (!isSOSActive && !isZooming) {
                        fetchAndDisplayData();
                        fetchSOSAlerts();
                        loadDeviceIDs();
                    }
                }, 2000); // Refresh every 2 seconds
                console.log("Auto-refresh started for today");
            } else {
                console.log("Auto-refresh not started; date is not today");
            }
        }

        // Stop auto-refreshing
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log("Auto-refresh stopped");
            }
        }

        // Handle form submission for tracking
        function handleSubmit(event) {
            event.preventDefault();
            stopAutoRefresh();
            fetchAndDisplayData();
            startAutoRefresh();
        }

        // Show the Device Tracker section
        function showDeviceTracker() {
            document.getElementById('device-tracker-form').style.display = 'block';
            document.getElementById('device-module-section').style.display = 'none';
            document.querySelector('.nav-bar a:nth-child(1)').classList.add('active');
            document.querySelector('.nav-bar a:nth-child(2)').classList.remove('active');
            hideMessage('device-module');
            startAutoRefresh();
        }

        // Show the Device Module section
        function showDeviceModule() {
            document.getElementById('device-tracker-form').style.display = 'none';
            document.getElementById('device-module-section').style.display = 'block';
            document.querySelector('.nav-bar a:nth-child(1)').classList.remove('active');
            document.querySelector('.nav-bar a:nth-child(2)').classList.add('active');
            hideMessage('device-tracker');
            stopAutoRefresh();
            loadDeviceConfigs();
        }

        // Save device configuration changes
        function saveDeviceConfig() {
            const devices = Array.from(document.querySelectorAll('.device-checkbox input[type="radio"]'));
            const colorPicker = document.getElementById('color-picker');
            const selectedDevice = devices.find(device => device.checked);

            if (!selectedDevice) {
                showMessage('Please select a device to configure', true, false, 'device-module');
                return;
            }

            const configData = devices.map(device => ({
                device_id: device.value,
                is_active: device.checked,
                color: device.checked ? colorPicker.value : deviceColors[device.value]
            }));

            showMessage('Saving configuration...', false, false, 'device-module');

            fetch('/save_device_configs/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(configData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Color changes successfully!', false, false, 'device-module');
                    setTimeout(() => hideMessage('device-module'), 3000);
                    loadDeviceConfigs();
                    fetchAndDisplayData();
                } else {
                    showMessage(data.error || 'Error saving configuration', true, false, 'device-module');
                }
            })
            .catch(error => {
                console.error('Error saving config:', error);
                showMessage('Network error while saving configuration', true, false, 'device-module');
            });
        }

        // Utility function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Window onload event to initialize the application
        window.onload = function() {
            // Set today's date as default in the date picker
            function setDefaultDate() {
                const dateInput = document.getElementById('date');
                const today = new Date();
                dateInput.value = today.toISOString().split('T')[0];
            }

            setDefaultDate();
            loadDeviceIDs();
            fetchAndDisplayData();
            fetchSOSAlerts();
            startAutoRefresh();

            // Stop auto-refresh on user interaction
            document.getElementById('device_id').addEventListener('change', stopAutoRefresh);
            document.getElementById('date').addEventListener('input', () => {
                stopAutoRefresh();
                fetchAndDisplayData();
                startAutoRefresh();
            });
            document.getElementById('time_filter').addEventListener('change', () => {
                stopAutoRefresh();
                fetchAndDisplayData();
                startAutoRefresh();
            });
        };
    </script>

    <!-- Additional JavaScript libraries -->
    <script src="{% static 'js/jquery-3.3.1.slim.min.js' %}"></script>
    <script src="{% static 'js/popper.min.js' %}"></script>
    <script src="{% static 'js/bootstrap.min.js' %}"></script>
    <script src="{% static 'js/select2.min.js' %}"></script>

    <!-- Initialize Select2 for all select elements -->
    <script>
        $(function () {
            $('select').each(function () {
                $(this).select2({
                    theme: 'bootstrap4',
                    width: 'style',
                    placeholder: $(this).attr('placeholder'),
                    allowClear: Boolean($(this).data('allow-clear')),
                });
            });
        });
    </script>

    <!-- Logout function to redirect to logout URL -->
    <script>
        function logoutUser() {
            window.location.href = "{% url 'logout' %}";
        }
    </script>
</body>
</html>
